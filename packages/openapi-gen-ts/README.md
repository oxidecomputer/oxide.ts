# @oxide/openapi-gen-ts

This is an TypeScript OpenAPI client generator built specifically for use with
specs generated by [Dropshot](https://github.com/oxidecomputer/dropshot). It has
not been tested on any other specs and is unlikely to handle them well.

## Interesting files

The core logic for looping over the spec and creating the methods is in
[`src/client/api.ts`](./src/client/api.ts) and the mapping from
OpenAPI schemas to TS types is in [`src/schema/types.ts`](./src/schema/types.ts). The mapping from OpenAPI schemas to Zod schemas is in
[`src/schema/zod.ts`](./src/schema/zod.ts).

The files in [`src/client/static/`](./src/client/static/) are copied over to
the client as-is during generation. We generate several distinct pieces:

| File                                        | Description                                                                                            |
| ------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| [`Api.ts`](client/Api.ts)                   | A [Fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)-based TS client to the Oxide API |
| [`validate.ts`](client/validate.ts)         | [Zod](https://github.com/colinhacks/zod) validators for API request and response types                 |
| [`msw-handlers.ts`](client/msw-handlers.ts) | Helpers used to build a mock API with [Mock Service Worker](https://mswjs.io/) in the console repo     |


## Why a custom generator?

We tried many existing generators, and while most worked in a basic sense, we
found it hard to make customizations, whether through CLI flags, templates, or
patching with [patch-package](https://github.com/ds300/patch-package). We
decided to prototype our own TS generator after seeing other Oxide devs do the
same for Rust ([progenitor](https://github.com/oxidecomputer/progenitor) and
[oxide.rs](https://github.com/oxidecomputer/oxide.rs)) and Go
([oxide.go](https://github.com/oxidecomputer/oxide.go)). It quickly became clear
that a special-purpose generator could be dramatically simpler than a general
one, so writing one was easier than existing generators made it look.

## Generating the client

```bash
# optional: update omicron sha in OMICRON_VERSION
./tools/gen.sh
```

The TypeScript client code will be written to `packages/api/src`.

## Publishing to npm

TBD

